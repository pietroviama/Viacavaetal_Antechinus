---
title: "Viacavaetal_Antechinus_GeneralAnalysis"
author: "PViacava"
date: "15/04/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '../Viacavaetal_Antechinus/Data', echo = TRUE)

#load libraries

library(ggplot2)
library(digest)
library(rgl)
library(geomorph)
library(vegan) # vegan version 2.4-4
library(Morpho)
library(ape)
library(raster)
library(sp)
library(MASS)
library(RColorBrewer)
library(shapes)
library(ALA4R)
library(ggsignif)

if(!require(devtools)) install.packages("devtools")
library(devtools)
devtools::install_github("TGuillerme/landvR")
library(landvR)

```



```{r load data}
#Import 3D coordinates from all specimens
coords.3D <- t (read.csv("C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data/Antechinus_LMcoords.csv", header = TRUE, row.names = 1))
dim(coords.3D)

#Convert 2D metadata into a 3D array
A <- arrayspecs(coords.3D, 82, 3)
dim(A)
Ahead <- head(dimnames(A))[3]

#Load the classifier
antechinusdata <- read.csv("C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data/Antechinus_data.csv", header=T)
dim(antechinusdata)
Data.species <- antechinusdata$Species
is.factor(Data.species) # check that it is a factor





#give museum ID row names to quolls data
rownames(antechinusdata)<-antechinusdata$ID

####Rearrange coordinate names and classifier file names in the same order

names_array <- dimnames(A)[[3]]
names_classifier <- rownames(antechinusdata)
match(names_array, names_classifier)
A_reorder <- A[,,match(names_classifier, names_array)]

names_Areorder <- dimnames(A_reorder)[[3]]
match(names_Areorder, names_classifier)

#CLEANED VERY ROUGHLY, RECHECK SPECIMENS THAT CAN BE INCLUDED IN THE ANALYSIS
A_reorder <- A_reorder[,,-c(which(antechinusdata$Age=="Juvenile?"), which(antechinusdata$Population=="adustus?"), which(antechinusdata$Population=="agilis?"), which(antechinusdata$ID=="CM3642"))]

antechinusdata <- antechinusdata[-c(which(antechinusdata$Age=="Juvenile?"), which(antechinusdata$Population=="adustus?"), which(antechinusdata$Population=="agilis?"), which(antechinusdata$ID=="CM3642")),]
antechinusdata <- droplevels(antechinusdata)

#####DO THAT######


gpaall<-gpagen(A_reorder, curves = NULL, surfaces = NULL, PrinAxes = TRUE,
                   max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)


#include precipitation and temperature data from worldclim

rclim<- getData("worldclim",var="bio",res=10) #run in console

rclim <- rclim[[c(1,12)]]
names(rclim) <- c("Temp","Prec")

lons <- antechinusdata$Longitude
lats <- antechinusdata$Latitude

coordsgps <- data.frame(lons, lats)

valuestemp <- extract(rclim,coordsgps)

dfwtemp <- cbind.data.frame(coordsgps,valuestemp)

dfwtemp

#frame data for geomorph

gdfante <- geomorph.data.frame(gpaall, Species = antechinusdata$Species, Population = antechinusdata$Population, ID = antechinusdata$ID, Sex = antechinusdata$Sex, Latitude = antechinusdata$Latitude, Longitude = antechinusdata$Longitude, Altitude = antechinusdata$Altitude, Dat_coll = antechinusdata$Date.collected, Collection = antechinusdata$Collection,
                           tempworldclim = dfwtemp$Prec, tempworldclim = dfwtemp$Temp, Age = antechinusdata$Age, doubt = antechinusdata$doubt) 

```

## Including Plots

You can also embed plots, for example:

```{r exploratory analysis for all, include=TRUE}

#PCA for all specimens

PCAante <- plotTangentSpace(gdfante$coords, warpgrids = FALSE, mesh = FALSE, groups = gdfante$Population, legend = gdfante$ID, label = gdfante$ID)

summary(PCAante)

cols<-brewer.pal(n=5,name="Set1")
cols_dat<-cols[gdfante$Population]

PCAanteplot <- plot(PCAante$pc.scores[,1], PCAante$pc.scores[,2], col = cols_dat, pch = c(16:18)[factor(gdfante$Sex)], cex = 2, asp = T, xlab="Principal Component 1 (19.68%)", ylab="Principal Component 2 (8.55%)")
text(PCAante$pc.scores[,1], PCAante$pc.scores[,2], labels=gdfante$ID, pos=4)
#need to correct legend
#legend(0.04, 0.02, legend=paste(rep(c("Female","Male","unknown"), times=2), rep(c("subtropicus","stuartii south", "stuartii north"), each=2), sep=","), col = rep(cols_dat, times=2), pch=rep(c(16:17), each=2), bty="n",ncol=2,cex=1.5,pt.cex=1.5, x.intersp = 0.2, text.width = 0.01)


#ggplot PCA (nicer)

Population <- gdfante$Population
Sex <- gdfante$Sex
dataPCA <- data.frame(PCAante$pc.scores[,1], PCAante$pc.scores[,2], Population, Sex)

plotPCA <- ggplot(dataPCA, aes(x=PCAante.pc.scores...1., y=PCAante.pc.scores...2., colour = Population, shape = Sex)) +
  labs(x = "PC 1 (19.68%)", y = "PC 2 (8.55%)") +
  scale_color_manual(values = c("grey", "red", "blue", "darkgreen", "orange")) +
  geom_point(size = 8, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text = element_text(size = 25), legend.title = element_text(size = 25), axis.title.x = element_text(size = 25), axis.title.y = element_text(size = 25), axis.text = element_text(size = 20), legend.justification = "center")

plot(plotPCA)

#Sex analysis

A_reordersex <- A_reorder[,,-which(antechinusdata$Sex=="Unknown")]

antechinusdatasex <- antechinusdata[-which(antechinusdata$Sex=="Unknown"),]
antechinusdatasex <- droplevels(antechinusdatasex)


gpaallsex<-gpagen(A_reordersex, curves = NULL, surfaces = NULL, PrinAxes = TRUE,
                   max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)

gdfantesex <- geomorph.data.frame(gpaallsex, Species = antechinusdatasex$Species, Population = antechinusdatasex$Population, ID = antechinusdatasex$ID, Sex = antechinusdatasex$Sex, Latitude = antechinusdatasex$Latitude, Longitude = antechinusdatasex$Longitude, Altitude = antechinusdatasex$Altitude, Dat_coll = antechinusdatasex$Date.collected, Collection = antechinusdatasex$Collection, doubt = antechinusdatasex$doubt) 

#PCA sex

PCAantesex <- plotTangentSpace(gdfantesex$coords, warpgrids = FALSE, mesh = FALSE, groups = gdfantesex$Sex)
summary(PCAantesex)

Sex <- gdfantesex$Sex
dataPCAsex <- data.frame(PCAantesex$pc.scores[,1], PCAantesex$pc.scores[,2], Sex)

plotPCAsex <- ggplot(dataPCAsex, aes(x=PCAantesex.pc.scores...1., y=PCAantesex.pc.scores...2., colour = Sex, shape = Sex)) +
  labs(x = "PC 1 (19.9%)", y = "PC 2 (8.4%)") +
  scale_color_manual(values = c("yellow4", "purple4")) +
  geom_point(size = 8, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text = element_text(size = 25), legend.title = element_text(size = 25), axis.title.x = element_text(size = 25), axis.title.y = element_text(size = 25), axis.text = element_text(size = 20), legend.justification = "center")

plot(plotPCAsex)


#Are sexes different in shape?

fit.shapesex <- procD.lm(coords~Sex, data = gdfantesex, effect.type = "F")
summary(fit.shapesex)
#yes

#Is there a common allometry or are there unique allometries across sexes? 

fit.sex.uni <- procD.lm(f1 = coords~Csize*Sex, data = gdfantesex, effect.type = "F")
summary(fit.sex.uni)
#common allometric relationship

#Are there shape differences between sexes after correcting for size? 

fit.sex <- procD.lm(f1 = coords~Csize+Sex, data = gdfantesex, effect.type = "F")
summary(fit.sex)

#Are sexes different in Centroid Size (proxy for size)? (Table 1)

lmsizesex <- lm(gdfantesex$Csize~gdfantesex$Sex)
anova(lmsizesex)
summary(lmsizesex)

#sex boxplot

df.antesex <- data.frame(gdfantesex$Csize, gdfantesex$Sex)

Sexbplot <- ggplot(df.antesex, 
                       aes(x = gdfantesex.Sex, 
                           y = gdfantesex.Csize, 
                           fill = gdfantesex.Sex)) +
  scale_fill_manual(values = c("yellow4", "purple4")) +
  labs(x= NULL, y= "Centroid Size",
       title= NULL) +
  geom_boxplot() +
  geom_point() +
  theme_classic() +
  theme(legend.position = "none", axis.text.x = element_text(size = 25), axis.text.y = element_text(size = 15), axis.title.y = element_text(size=25))

plot(Sexbplot)





#exclude dubious population identities
#(RECHECK SPECIMENS THAT CAN STILL BE INCLUDED IN THE ANALYSIS (ANDREW COULD HELP))


A_reorderpop <- A_reorder[,,-c(which(antechinusdata$Population=="?"), which(antechinusdata$Population=="subtropicus holotype"))]

antechinusdatapop <- antechinusdata[-c(which(antechinusdata$Population=="?"), which(antechinusdata$Population=="subtropicus holotype")),]
antechinusdatapop <- droplevels(antechinusdatapop)


gpaallpop<-gpagen(A_reorderpop, curves = NULL, surfaces = NULL, PrinAxes = TRUE,
                   max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)


#include precipitation and temperature data from worldclim


rclim<- getData("worldclim",var="bio",res=10) #run in console

rclimpop <- rclim[[c(1,12)]]
names(rclimpop) <- c("Temp","Prec")

lonspop <- antechinusdatapop$Longitude
latspop <- antechinusdatapop$Latitude

coordsgpspop <- data.frame(lonspop, latspop)

valuestemppop <- extract(rclimpop,coordsgpspop)

dfwtemppop <- cbind.data.frame(coordsgpspop,valuestemppop)

dfwtemppop


antegps <- data.frame(antechinusdatapop$Latitude, antechinusdatapop$Longitude)
evariables <- c("el830", "el674")
retrieved.evariables <- intersect_points(antegps, evariables)

retrieved.evariables$distanceToPermanentWaterWeighted[is.na(retrieved.evariables$distanceToPermanentWaterWeighted)]<-0
retrieved.evariables$elevation[is.na(retrieved.evariables$elevation)]<-0


antechinusdatapop$distanceTowater <- retrieved.evariables$distanceToPermanentWaterWeighted
antechinusdatapop$elevation <- retrieved.evariables$elevation

#frame data for geomorph

gdfantepop <- geomorph.data.frame(coords = gpaallpop$coords, Csize = gpaallpop$Csize, Species = antechinusdatapop$Species, Population = antechinusdatapop$Population, ID = antechinusdatapop$ID, Sex = antechinusdatapop$Sex, Latitude = antechinusdatapop$Latitude, Longitude = antechinusdatapop$Longitude, Altitude = antechinusdatapop$Altitude, Dat_coll = antechinusdatapop$Date.collected, Collection = antechinusdatapop$Collection,
                           ppworldclim = dfwtemppop$Prec, tempworldclim = dfwtemppop$Temp, Age = antechinusdatapop$Age, doubt = antechinusdatapop$doubt, distanceTowater = antechinusdatapop$distanceTowater, elevation = antechinusdatapop$elevation) 

PCAantepop <- plotTangentSpace(gdfantepop$coords, warpgrids = FALSE, mesh = FALSE, groups = gdfantepop$Population, legend = gdfantepop$Population)

summary(PCAantepop)


Populationpop <- gdfantepop$Population
Sexpop <- gdfantepop$Sex
dataPCApop <- data.frame(PCAantepop$pc.scores[,1], PCAantepop$pc.scores[,2], Populationpop, Sexpop)

plotPCApop <- ggplot(dataPCApop, aes(x=PCAantepop.pc.scores...1., y=PCAantepop.pc.scores...2., colour = Populationpop, shape = Sexpop)) +
  labs(x = "PC 1 (22.87%)", y = "PC 2 (8.93%)") +
  scale_color_manual(values = c("red", "blue", "darkgreen")) +
  geom_point(size = 8, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text = element_text(size = 25), legend.title = element_text(size = 25), axis.title.x = element_text(size = 25), axis.title.y = element_text(size = 25), axis.text = element_text(size = 20), legend.justification = "center")

plot(plotPCApop)

###########
##########
#############

summary(lm(gdfantepop$Csize~PCAantepop$pc.scores[,1]))
summary(lm(gdfantepop$Csize~PCAantepop$pc.scores[,2]))
summary(lm(gdfantepop$Csize~PCAantepop$pc.scores[,3]))

# Allometry figure 

fit.sizepop <- procD.lm(f1 = coords~Csize, data = gdfantepop, print.progress = FALSE)
fit.size.plotpop <- plotAllometry(fit.sizepop, size = gdfantepop$Csize, logsz = FALSE, method = "RegScore", pch = 19, col = as.numeric(gdfantepop$Population), cex = 3)
anova(fit.sizepop)

dataallometryplotpop <- data.frame(fit.size.plotpop$size.var, fit.size.plotpop$RegScore, Populationpop, Sexpop)

plotallompop <- ggplot(dataallometryplotpop, aes(x=fit.size.plotpop.size.var, y=fit.size.plotpop.RegScore, colour = Populationpop, shape = Sexpop)) +
  labs(x = "Centroid Size", y = "Shape Score") +
    scale_color_manual(values = c("red", "blue", "darkgreen")) +
  geom_point(size = 8, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text = element_text(size = 25), legend.title = element_text(size = 25), axis.title.x = element_text(size = 25), axis.title.y = element_text(size = 25), axis.text = element_text(size = 20), legend.justification = "center")

plot(plotallompop)


#shape changes associated with allometry 

predshapesize <- shape.predictor(gpaallpop$coords, x=gpaallpop$Csize, Intercept = TRUE, predmin = min(gpaallpop$Csize), predmax = max(gpaallpop$Csize))

allomshapediff <- coordinates.difference(predshapesize$predmin, predshapesize$predmax, type = "spherical")
procrustes.var.plot(predshapesize$predmin, predshapesize$predmax, col = list(grDevices::heat.colors, "black"), allomshapediff[[1]][,"radius"], col.range = c(0, 0.015), pt.size = 0.5)


tps3dallommin <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], predshapesize$predmin)
tps3dallommax <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], predshapesize$predmax)

warpmovie3d(tps3dallommin, tps3dallommax, n=15, col = "grey", palindrome = TRUE,
            folder = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Figures/warp3dmovies", movie = "warpmovieallom", add = FALSE, close = TRUE,
            countbegin = 0, ask = TRUE, radius = NULL, xland = NULL,
            yland = NULL, lmcol = "black")


#Is there a common allometry or are there unique allometries across sexes? 

fit.pop.uni <- procD.lm(f1 = coords~Csize*Population, data = gdfantepop, effect.type = "F")
summary(fit.pop.uni)
#common allometric relationship

#Are there shape differences between sexes after correcting for size? 

fit.sizeadj.pop <- procD.lm(f1 = coords~Csize+Population, data = gdfantepop, effect.type = "F")
summary(fit.sizeadj.pop)

#Are populations different in shape?

fitpop <- procD.lm(coords~Population, data = gdfantepop, iter = 999, effect.type = "F")
anova(fitpop)

#yes, which ones are different?

PWpop <- pairwise(fitpop, groups = gdfantepop$Population)
PWpop.sum <- summary(PWpop, test.type = "dist", confidence = 0.95, stat.table = FALSE)
PWpop.sum

#Bonferroni correction
PW1.pvals <- PWpop.sum$pairwise.tables$P[c(2,3,6)]
PW1.pvals.adj <- p.adjust(PW1.pvals, "bonferroni")
PW1.pvals.adj

#disparity differences

disparitypops <- morphol.disparity(fitpop, groups = ~ Population, data = gdfantepop, iter = 999)
summary(disparitypops)


fitsizepop <- procD.lm(Csize~Population, data = gdfantepop, iter = 999, effect.type = "F")
summary(fitsizepop)
PWsizepop<- pairwise(fitsizepop, groups = gdfantepop$Population)

sumPWsizepop <- summary(PWsizepop, test.type = "dist", confidence = 0.95, stat.table = FALSE)
sumPWsizepop


#population size boxplot

df.antepop <- data.frame(gdfantepop$Csize, gdfantepop$Population)

Popbplot <- ggplot(df.antepop, 
                      aes(x = reorder(gdfantepop.Population, gdfantepop.Csize, FUN = median), 
                           y = gdfantepop.Csize, 
                           fill = gdfantepop.Population)) +
  scale_fill_manual(values = c("red", "blue", "darkgreen")) +
  labs(x= NULL, y= "Centroid Size",
       title= NULL) +
  geom_boxplot() +
    stat_compare_means(comparisons = list(c("south", "north"), c("north","subtropicus"), c("south", "subtropicus")), label = "p.signif", method = "t.test") +
  geom_point() +
  theme_classic() +
  theme(legend.position = "none", axis.text.x = element_text(size = 25), axis.text.y = element_text(size = 15), axis.title.y = element_text(size=25))

plot(Popbplot)

#heatmaps

femalecoords <- gdfantesex$coords[,,which(gdfantesex$Sex=="Female")]
mshapefemale <- mshape(femalecoords)
malecoords <- gdfantesex$coords[,,which(gdfantesex$Sex=="Male")]
mshapemale <- mshape(malecoords)

mshapefemalemale <- coordinates.difference(mshapefemale, mshapemale, type = "spherical")
procrustes.var.plot(mshapefemale, mshapemale, col = list(grDevices::heat.colors, "black"), pt.size = 0.5, col.val = mshapefemalemale[[1]][,"radius"])

G34.ply <- read.ply(file = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data/3Dmodels/AntechinusAll3Dmodels/G34.ply")

femalewarp <- warpRefMesh(G34.ply, mesh.coord = gdfantesex$coords[,,which(gdfantesex$ID=="G34")], ref = mshapefemale)

malewarp <- warpRefMesh(G34.ply, mesh.coord = gdfantesex$coords[,,which(gdfantesex$ID=="G34")], ref = mshapemale)



#populations

northcoords <- gdfantepop$coords[,,which(gdfantepop$Population=="north")]
mshapenorth <- mshape(northcoords)
southcoords <- gdfantepop$coords[,,which(gdfantepop$Population=="south")]
mshapesouth <- mshape(southcoords)
subtropicuscoords <- gdfantepop$coords[,,which(gdfantepop$Population=="subtropicus")]
mshapesubtropicus <- mshape(subtropicuscoords)


#warp south vs north
tps3dsouthnorth <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], mshapesouth)
tps3dnorthsouth <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], mshapenorth)

warpmovie3d(tps3dsouthnorth, tps3dnorthsouth, n=15, col = "grey", palindrome = TRUE,
            folder = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Figures/warp3dmovies", movie = "warpmoviesouthnorth", add = FALSE, close = TRUE,
            countbegin = 0, ask = TRUE, radius = NULL, xland = NULL,
            yland = NULL, lmcol = "black")

#warp north vs subtropicus

tps3dnorthsub <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], mshapenorth)
tps3dsubnorth <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], mshapesubtropicus)

warpmovie3d(tps3dnorthsub, tps3dsubnorth, n=15, col = "grey", palindrome = TRUE,
            folder = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Figures/warp3dmovies", movie = "warpmoviesubnorth", add = FALSE, close = TRUE,
            countbegin = 0, ask = TRUE, radius = NULL, xland = NULL,
            yland = NULL, lmcol = "black")

#warp south vs subtropicus

tps3dsouthsub <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], mshapesouth)
tps3dsubsouth <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], mshapesubtropicus)

warpmovie3d(tps3dsouthsub, tps3dsubsouth, n=15, col = "grey", palindrome = TRUE,
            folder = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Figures/warp3dmovies", movie = "warpmoviesubsouth", add = FALSE, close = TRUE,
            countbegin = 0, ask = TRUE, radius = NULL, xland = NULL,
            yland = NULL, lmcol = "black")


#northwarp <- warpRefMesh(G34.ply, mesh.coord = gdfantepop$coords[,,which(gdfantepop$ID=="G34")], ref = mshapenorth)
#rgl.viewpoint(10, 60, fov = 0, zoom = 0.5)
#rgl.snapshot("C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Figures/mshapenorth", fmt = "png")


plotRefToTarget(mshapenorth, mshapesubtropicus, method="vector", gridPars=gridPar(pt.size=0.5))
plotRefToTarget(mshapesouth, mshapesubtropicus, method="vector", gridPars=gridPar(pt.size=0.5))
plotRefToTarget(mshapenorth, mshapesouth, method="vector", gridPars=gridPar(pt.size=0.5))

mshapenorthsubtropicus <- coordinates.difference(mshapenorth, mshapesubtropicus, type = "spherical")
mshapesouthsubtropicus <- coordinates.difference(mshapesouth, mshapesubtropicus, type = "spherical")
mshapenorthsouth <- coordinates.difference(mshapenorth, mshapesouth, type = "spherical")

procrustes.var.plot(mshapenorth, mshapesubtropicus, col = list(grDevices::heat.colors, "black"), pt.size = 0.5, col.val = mshapenorthsubtropicus[[1]][,"radius"])

procrustes.var.plot(mshapesouth, mshapesubtropicus, col = list(grDevices::heat.colors, "black"), pt.size = 0.5, col.val = mshapesouthsubtropicus[[1]][,"radius"])

procrustes.var.plot(mshapenorth, mshapesouth, col = list(grDevices::heat.colors, "black"), pt.size = 0.5, col.val = mshapenorthsouth[[1]][,"radius"])

#shape driven by PC1

mshapePC1minmax<-coordinates.difference(PCAantepop$pc.shapes$PC1min,PCAantepop$pc.shapes$PC1max, type = "spherical")

procrustes.var.plot(PCAantepop$pc.shapes$PC1min, PCAantepop$pc.shapes$PC1max, col = list(grDevices::heat.colors, "black"), col.val = mshapePC1minmax[[1]][,"radius"], col.range = c(0, 0.015), pt.size = 0.5)

#warp PC1min vs PC1max

tps3dPC1minmax <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], PCAantepop$pc.shapes$PC1min)
tps3dPC1maxmin <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], PCAantepop$pc.shapes$PC1max)

warpmovie3d(tps3dPC1minmax, tps3dPC1maxmin, n=15, col = "grey", palindrome = TRUE,
            folder = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Figures/warp3dmovies", movie = "tps3dPC1", add = FALSE, close = TRUE,
            countbegin = 0, ask = TRUE, radius = NULL, xland = NULL,
            yland = NULL, lmcol = "black")

#shape driven by PC2

mshapePC2minmax<-coordinates.difference(PCAantepop$pc.shapes$PC2min,PCAantepop$pc.shapes$PC2max, type = "spherical")

procrustes.var.plot(PCAantepop$pc.shapes$PC2min, PCAantepop$pc.shapes$PC2max, col = list(grDevices::heat.colors, "black"), col.val = mshapePC2minmax[[1]][,"radius"], col.range = c(0, 0.015), pt.size = 0.5)

#warp PC2min vs PC2max

tps3dPC2minmax <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], PCAantepop$pc.shapes$PC2min)
tps3dPC2maxmin <- tps3d(G34.ply, A_reorder[,,which(antechinusdata$ID=="G34")], PCAantepop$pc.shapes$PC2max)

warpmovie3d(tps3dPC2minmax, tps3dPC2maxmin, n=15, col = "grey", palindrome = TRUE,
            folder = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Figures/warp3dmovies", movie = "tps3dPC2", add = FALSE, close = TRUE,
            countbegin = 0, ask = TRUE, radius = NULL, xland = NULL,
            yland = NULL, lmcol = "black")

#ProcANOVA

fitshapelat<-procD.lm(gdfantepop$coords~Latitude, data = gdfantepop, effect.type = "F")
summary(fitshapelat)

fitshapelon<-procD.lm(gdfantepop$coords~Longitude, data = gdfantepop, effect.type = "F")
summary(fitshapelon)

lmsizelat<- procD.lm(Csize~Latitude, data = gdfantepop, iter = 999, effect.type = "F")
summary(lmsizelat)

lmsizelon<- procD.lm(Csize~Longitude, data = gdfantepop, iter = 999, effect.type = "F")
summary(lmsizelon)


#separate pops and do gpas on them
gpasouth<-gpagen(A_reorder[,,c(which(antechinusdata$Population=="south"))], curves = NULL, surfaces = NULL, PrinAxes = TRUE, max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)
antesouthlat <- antechinusdata$Latitude[c(which(antechinusdata$Population=="south"))]
antesouthlon <- antechinusdata$Longitude[c(which(antechinusdata$Population=="south"))]

gpanorth<-gpagen(A_reorder[,,c(which(antechinusdata$Population=="north"))], curves = NULL, surfaces = NULL, PrinAxes = TRUE, max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)
antenorthlat <- antechinusdata$Latitude[c(which(antechinusdata$Population=="north"))]
antenorthlon <- antechinusdata$Longitude[c(which(antechinusdata$Population=="north"))]

gpasub<-gpagen(A_reorder[,,c(which(antechinusdata$Population=="subtropicus"))], curves = NULL, surfaces = NULL, PrinAxes = TRUE, max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)
antesublat <- antechinusdata$Latitude[c(which(antechinusdata$Population=="subtropicus"))]
antesublon <- antechinusdata$Longitude[c(which(antechinusdata$Population=="subtropicus"))]


fitshapesouthlat<-procD.lm(gpasouth$coords~antesouthlat, effect.type = "F")
summary(fitshapesouthlat)
fitshapenorthlat<-procD.lm(gpanorth$coords~antenorthlat, effect.type = "F")
summary(fitshapenorthlat)
fitshapesublat<-procD.lm(gpasub$coords~antesublat, effect.type = "F")
summary(fitshapesublat)


fitsizesouthlat<-procD.lm(gpasouth$Csize~antesouthlat, effect.type = "F")
summary(fitsizesouthlat)
fitsizenorthlat<-procD.lm(gpanorth$Csize~antenorthlat, effect.type = "F")
summary(fitsizenorthlat)
fitsizesublat<-procD.lm(gpasub$Csize~antesublat, effect.type = "F")
summary(fitsizesublat)




fitshapesouthlon<-procD.lm(gpasouth$coords~antesouthlon, effect.type = "F")
summary(fitshapesouthlon)
fitshapenorthlon<-procD.lm(gpanorth$coords~antenorthlon, effect.type = "F")
summary(fitshapenorthlon)
fitshapesublon<-procD.lm(gpasub$coords~antesublon, effect.type = "F")
summary(fitshapesublon)


fitsizesouthlon<-procD.lm(gpasouth$Csize~antesouthlon, effect.type = "F")
summary(fitsizesouthlon)
fitsizenorthlon<-procD.lm(gpanorth$Csize~antenorthlon, effect.type = "F")
summary(fitsizenorthlon)
fitsizesublon<-procD.lm(gpasub$Csize~antesublon, effect.type = "F")
summary(fitsizesublon)







fitshapetempmain <- procD.lm(coords~tempworldclim, data = gdfantepop, effect.type = "F")
summary(fitshapetempmain)

fitshapeppmain <- procD.lm(coords~ppworldclim, data = gdfantepop, effect.type = "F")
summary(fitshapeppmain)

lmsizetempmain <- lm(gdfantepop$Csize~gdfantepop$tempworldclim)
anova(lmsizetempmain)
summary(lmsizetempmain)

lmsizeppmain <- lm(gdfantepop$Csize~gdfantepop$ppworldclim)
anova(lmsizeppmain)
summary(lmsizeppmain)

fitshapedistwatermain <- procD.lm(coords~distanceTowater, data = gdfantepop, effect.type = "F")
summary(fitshapedistwatermain)

lmsizedistwatermain <- lm(gdfantepop$Csize~gdfantepop$distanceTowater)
anova(lmsizedistwatermain)
summary(lmsizedistwatermain)

fitshapeelevmain <- procD.lm(coords~elevation, data = gdfantepop, effect.type = "F")
summary(fitshapeelevmain)

lmsizeelevmain <- lm(gdfantepop$Csize~gdfantepop$elevation)
anova(lmsizeelevmain)
summary(lmsizeelevmain)



```
``` {r residual shape analyses, include = TRUE}

#calculate residual shape

fit.size <- procD.lm(f1 = coords~Csize, data = gdfante, print.progress = FALSE)

main_residuals3D <- arrayspecs(fit.size$residuals, 82, 3)

allom_resplusconsensus <- main_residuals3D + array(gpaall$consensus,dim(main_residuals3D))

allom_resplusconsensuspop <- allom_resplusconsensus[,,-c(which(antechinusdata$Population=="?"), which(antechinusdata$Population=="subtropicus holotype"))]


gparespop<-gpagen(allom_resplusconsensuspop, curves = NULL, surfaces = NULL, PrinAxes = TRUE,
                   max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)

gdfresantepop <- geomorph.data.frame(coords = gparespop$coords, Csize = gparespop$Csize, Species = antechinusdatapop$Species, Population = antechinusdatapop$Population, ID = antechinusdatapop$ID, Sex = antechinusdatapop$Sex, Latitude = antechinusdatapop$Latitude, Longitude = antechinusdatapop$Longitude, Altitude = antechinusdatapop$Altitude, Dat_coll = antechinusdatapop$Date.collected, Collection = antechinusdatapop$Collection,
                           ppworldclim = dfwtemppop$Prec, tempworldclim = dfwtemppop$Temp, Age = antechinusdatapop$Age, doubt = antechinusdatapop$doubt, distanceTowater = antechinusdatapop$distanceTowater, elevation = antechinusdatapop$elevation) 

PCAresantepop <- plotTangentSpace(gdfresantepop$coords, warpgrids = FALSE, mesh = FALSE, groups = gdfresantepop$Population, legend = gdfresantepop$Population)

summary(PCAresantepop)



Populationpop <- gdfantepop$Population
Sexpop <- gdfantepop$Sex
dataPCArespop <- data.frame(PCAresantepop$pc.scores[,1], PCAresantepop$pc.scores[,2], Populationpop, Sexpop)

plotPCArespop <- ggplot(dataPCArespop, aes(x=PCAresantepop.pc.scores...1., y=PCAresantepop.pc.scores...2., colour = Populationpop, shape = Sexpop)) +
  labs(x = "PC 1 (16.08%)", y = "PC 2 (8.62%)") +
  scale_color_manual(values = c("red", "blue", "darkgreen")) +
  geom_point(size = 8, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text = element_text(size = 25), legend.title = element_text(size = 25), axis.title.x = element_text(size = 25), axis.title.y = element_text(size = 25), axis.text = element_text(size = 20), legend.justification = "center")

plot(plotPCArespop)

#Are populations different in residual shape?

fitpopres <- procD.lm(coords~Population, data = gdfresantepop, iter = 999, effect.type = "F")
anova(fitpopres)

#yes, which ones are different?

PWpopres <- pairwise(fitpopres, groups = gdfresantepop$Population)
PWpopres.sum <- summary(PWpopres, test.type = "dist", confidence = 0.95, stat.table = FALSE)
PWpopres.sum

#disparity differences on residual shape

disparitypopsres <- morphol.disparity(fitpopres, groups = ~ Population, data = gdfresantepop, iter = 999)
summary(disparitypopsres)

# residual shapes of populations

northrescoords <- gdfresantepop$coords[,,which(gdfresantepop$Population=="north")]
mshapenorthres <- mshape(northrescoords)
southrescoords <- gdfresantepop$coords[,,which(gdfresantepop$Population=="south")]
mshapesouthres <- mshape(southrescoords)
subtropicusrescoords <- gdfresantepop$coords[,,which(gdfresantepop$Population=="subtropicus")]
mshapesubtropicusres <- mshape(subtropicusrescoords)


mshaperessouthnorth <- coordinates.difference(mshapesouthres, mshapenorthres, type = "spherical")
mshaperesnorthsubtropicus <- coordinates.difference(mshapenorthres, mshapesubtropicusres, type = "spherical")
mshaperessouthsubtropicus <- coordinates.difference(mshapesouthres, mshapesubtropicusres, type = "spherical")

procrustes.var.plot(mshapesouthres, mshapenorthres, col = list(grDevices::heat.colors, "black"), pt.size = 0.5, col.val = mshaperessouthnorth[[1]][,"radius"])

procrustes.var.plot(mshapenorthres, mshapesubtropicusres, col = list(grDevices::heat.colors, "black"), pt.size = 0.5, col.val = mshaperesnorthsubtropicus[[1]][,"radius"])

procrustes.var.plot(mshapesouthres, mshapesubtropicusres, col = list(grDevices::heat.colors, "black"), pt.size = 0.5, col.val = mshaperessouthsubtropicus[[1]][,"radius"])




```


``` {r variation partitioning analysis on mainland specimens, include = TRUE}

#Perform a PCA to overcome autocorrelation issues that may arise from geographic distances

specgeodist <- data.frame(gdfantepop$Latitude,gdfantepop$Longitude)
mat.specgeodist <- dist(specgeodist, method="euclidean", diag=F, upper=F)
pcnm <- pcnm(mat.specgeodist)

sum(pcnm$values[1:10]/sum(pcnm$values[1:24]))

spat.data<-pcnm$vectors[,1:10]

array2mat <- function(array,inds,vars){
  if(class(array)=="matrix"){array<-array(array,dim=c(nrow(array),ncol(array),1))}
  X1 <-aperm(array,c(3,2,1))
  dim(X1)<- c(inds, vars)
  if(!is.null(dimnames(array)[3])){rownames(X1)<-unlist(dimnames(array)[3])}else{rownames(X1)<-c(1:nrow(X1))}
  return(X1)
}


mymat<-array2mat(gpaallpop$coords,129,246)



### Figure 4: full variation partitioning model, from vegan library, test for constrained variation

mainprectemp <- data.frame(gdfantepop$ppworldclim, gdfantepop$tempworldclim/10)

matprectemp <- as.matrix(mainprectemp)

matCsizemain <- gpaallpop$Csize

mod<-varpart(mymat,~spat.data, ~matCsizemain, ~matprectemp[,c(1:2)])

showvarparts(3, bg = c("blue", "red", "black"), Xnames=c("Geography","Size","Climate"), cex = 2, id.size = 2)
plot(mod, bg = c("blue", "red", "black"), Xnames=c("Geography","Size","Climate"), cex = 2, id.size = 2)

full_rda<-vegan::rda(mymat~spat.data+matprectemp[,c(1:2)]+matCsizemain)### full model

geo.rda<-vegan::rda(mymat~spat.data+Condition(matprectemp[,c(1:2)])+Condition(matCsizemain))### fraction variance of the variable

clim.rda.shape<-vegan::rda(mymat~matprectemp[,c(1:2)]+Condition(spat.data)+Condition(matCsizemain))

size.rda.shape<-vegan::rda(mymat~matCsizemain+Condition(spat.data)+Condition(matprectemp[,c(1:2)]))

anova(full_rda)
RsquareAdj(full_rda)

anova(geo.rda)
RsquareAdj(geo.rda)

anova(clim.rda.shape)
RsquareAdj(clim.rda.shape)

anova(size.rda.shape)
RsquareAdj(size.rda.shape)

Eclim<-vegan::rda(mymat~matprectemp[,c(1:2)])
anova(Eclim)
RsquareAdj(Eclim)

Egeo<-vegan::rda(mymat~spat.data)
anova(Egeo)
RsquareAdj(Egeo)

Ecsize<-vegan::rda(mymat~matCsizemain)
anova(Ecsize)
RsquareAdj(Ecsize)
```


MR3.pts<-A_reorder[,,"MR3"]
open3d()
spheres3d(MR3.pts,radius = 0.2,col = 1)
text3d(MR3.pts, texts = c(1:82), asp = FALSE, cex = 2, col="blue", pos = 3)


MRG4.pts<-A_reorder[,,"MRG4"]
open3d()
spheres3d(MRG4.pts,radius = 0.2,col = 1)
text3d(MRG4.pts, texts = c(1:82), asp = FALSE, cex = 2, col="blue", pos = 3)



plot3d(PCAante$pc.scores[,1], PCAante$pc.scores[,2], PCAante$pc.scores[,3], col = cols_dat, type = "s", radius = .002, xlab="Principal Component 1 (19.92%)", ylab="Principal Component 2 (8.42%)", zlab = "Principal Component 3 (6.2%)", ann = FALSE, axes = FALSE)
box3d()
