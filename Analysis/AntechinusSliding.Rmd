---
title: "AntechinusSliding"
author: "PViacava"
date: "16/03/2020"
output: html_document
---
title: "Antechinus_sliding"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = 'C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data', echo = TRUE)



library(Morpho)
library(rgl)
library(Rvcg)
library(geomorph)

setwd('C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data')
```

```{r load data}

## import meshes and points cloud


subtropicus.holo<-file2mesh('3Dmodels/Asubtropicus/J17407.ply',readcol=F,clean=T)
subtropicus.p<-(read.csv('Templatecoords.csv', header = F))
dim(subtropicus.p)
rownames(subtropicus.p)<-subtropicus.p$V1

subtropicus.p1 <- subtropicus.p[,-1]

#A <- arrayspecs(subtropicus.p1, 412, 3)
#dim(A)
#Ahead <- head(dimnames(A))[3]
#template.p<-A[,,1]
#antestspecs<-A[,,2:5]
shade3d(subtropicus.holo,col=8)
spheres3d(subtropicus.p1[1:82,],radius=0.3,col=1)#fixed. nb of landmark = (z-1)/3
spheres3d(subtropicus.p1[83:267,],radius=0.2,col=2) #curves
spheres3d(subtropicus.p1[268:412,],radius=0.1,col=3) #patches

text3d(subtropicus.p1, texts = c(1:412), asp=FALSE, cex=1, col="blue", pos = 3 )

LMcoords <- t(read.csv('Antechinus_cranialvariation_data.csv', header = T, row.names = 1))
dim(LMcoords)
Ants <- arrayspecs(LMcoords, 82, 3)
dim(Ants)
Ahead <- head(dimnames(Ants))[3]
```

### 2nd step build symmetric patches, you can do this or not, it depends on your question.
## don't run now

#rpm<-c(1:27)
#lpm<-c(82:108)
#pm<-cbind(rpm,lpm)
#rfp<-c(28:50)
#lfp<-c(115:137)
#fp<-cbind(rfp,lfp)
#rn<-c(64:72)
#ln<-c(73:81)
#n<-cbind(rn,ln)

#sepe, oc and bo to do symmetrize

#symme1<-Morpho::symmetrize(c(template.p[1:27,], template.p[82:108]),pm)#128
#symme2<-Morpho::symmetrize(template.p[373:422,],fp)#50
#symme3<-Morpho::symmetrize(template.p[423:472,],n)#50

#reprojecting the points to the surface
#proji<-projRead(symme,pilio)
#proji1<-projRead(symme1,pilio)
#proji2<-projRead(symme2,pilio)
#proji3<-projRead(symme3,pilio)



#sym.patch<-t(proji$vb)[,-4]
#sym.patch1<-t(proji1$vb)[,-4]
#sym.patch2<-t(proji2$vb)[,-4]
#sym.patch3<-t(proji3$vb)[,-4]


## new set of points with symmetrically places points

#pilio.new<-rbind(pilio.p[1:40,],pilio.curves,pilio.p[117:522,])#sym.patch,sym.patch1,sym.patch2,sym.patch3,sym.patch4,sym.patch5)

#shade3d(pilio,col=8)
#spheres3d(pilio.new[505:522,],radius=0.5,col=1)
#text3d(pilio.new[505:522,1],pilio.new[505:522,2],pilio.new[505:522,3],c(505:522),cex=1.5,adj =1.5)

#spheres3d(pilio.new[41:116,],radius=0.5,col=2)
#spheres3d(pilio.new[117:522,],radius=0.5,col=3)

## read all points
#export in pts

#setwd("/Users/colonnello/Desktop/New Brain/points")
#nm<-list.files(path="/Users/colonnello/Desktop/New Brain/points")
#list.pts<-do.call(list,lapply(nm,function(x) read.pts(x)))

#try.arr<-array(unlist(list.pts),dim=c(40,3,9))
#40 = lms , 3 dimensions and 9 specimens
## all the meshes 
#setwd("/Users/colonnello/Desktop/New Brain/prova")
#nm2<-list.files(path="/Users/colonnello/Desktop/New Brain/prova")
#listish<-do.call(list,lapply(nm2,function(x) file2mesh(x,readcol=F,clean=T)))

## match names, very important

#nmi<-substr(nm2,1,nchar(nm2)-4)

#dimnames(try.arr)[[3]]<-nmi

```{r template creation}

#### create the template

fixed<-as.matrix(subtropicus.p1[1:82,])
patch<-as.matrix(subtropicus.p1[c(83:412),])
#patch semilandmark rows don't need renaming because they come first



#template.1<-createAtlas(subtropicus.holo,landmarks=fixed,patch=patch,
                        
         #patchCurves = list(as.integer(template.p[c(228:235),])))


#plotAtlas(template.1,pt.size=0.2,legend=FALSE,render="s")

# Declaration of rowindices of curves 
SC1<-as.integer(83)
SC2<-as.integer(c(84:86))
SC3<-as.integer(c(87:89))
SC4<-as.integer(c(90:92))
SC5<-as.integer(c(93:95))
SC6<-as.integer(96)
SC7<-as.integer(c(97:104))
SC8<-as.integer(c(105:107))
SC9<-as.integer(c(108:110))
SC10<-as.integer(c(111:113))
SC11<-as.integer(c(114:116))
SC12<-as.integer(c(117:120))
SC13<-as.integer(c(121:124))
SC14<-as.integer(c(125:127))
SC15<-as.integer(c(128:130))
SC16<-as.integer(c(131:132))
SC17<-as.integer(c(133:134))
SC18<-as.integer(c(135:136))
SC19<-as.integer(c(137:138))
SC20<-as.integer(c(139:143))
SC21<-as.integer(c(144:148))
SC22<-as.integer(c(149:151))
SC23<-as.integer(c(152:153))
SC24<-as.integer(c(154:157))
SC25<-as.integer(c(158:159))
SC26<-as.integer(160)
SC27<-as.integer(161)
SC28<-as.integer(162)
SC29<-as.integer(163)
SC30<-as.integer(c(164:166))
SC31<-as.integer(c(167:168))
SC32<-as.integer(c(169:172))
SC33<-as.integer(c(173:174))
SC34<-as.integer(175)
SC35<-as.integer(176)
SC36<-as.integer(177)
SC37<-as.integer(178)
SC38<-as.integer(c(179:180))
SC39<-as.integer(c(181:182))
SC40<-as.integer(c(183:187))
SC41<-as.integer(c(188:190))
SC42<-as.integer(c(191:193))
SC43<-as.integer(c(194:197))
SC44<-as.integer(c(198:201))
SC45<-as.integer(c(202:205))
SC46<-as.integer(c(206:209))
SC47<-as.integer(c(210:212))
SC48<-as.integer(c(213:215))
SC49<-as.integer(c(216:218))
SC50<-as.integer(c(219:223))
SC51<-as.integer(c(224:226))
SC52<-as.integer(c(227:231))
SC53<-as.integer(232)
SC54<-as.integer(233)
SC55<-as.integer(c(234:238))
SC56<-as.integer(c(239:243))
SC57<-as.integer(c(244:245))
SC58<-as.integer(c(246:247))
SC59<-as.integer(c(248:250))
SC60<-as.integer(c(251:253))
SC61<-as.integer(c(254:256))
SC62<-as.integer(c(257:264))
SC63<-as.integer(c(265:267))



# Creation d'une liste de toutes les courbes, incluant les lm anatomiques bordant les courbes

curves<-list(SC1,SC2,SC3,SC4,SC5,SC6,SC7,SC8,SC9,SC10,SC11,SC12,SC13,SC14,SC15,SC16,SC17,SC18,SC19,SC20,
             SC21,SC22,SC23,SC24,SC25,SC26,SC27,SC28)

#Atlas plot and original plot to check if the landmark numbers remain in the same order 

Atlas<-createAtlas(subtropicus.holo,landmarks=fixed,patch=patch, patchCurves = list(83, c(84:86), c(87:89), c(90:92), c(93:95), 96, c(97:104), c(105:107), c(108:110), c(111:113), c(114:116), c(117:120), c(121:124), c(125:127), c(128:130), c(131:132), c(133:134), c(135:136), c(137:138), c(139:143), c(144:148), c(149:151), c(152:153), c(154:157), c(158:159), 160, 161, 162, 163, c(164:166), c(167:168), c(169:172), c(173:174), 175, 176, 177, 178, c(179:180), c(181:182), c(183:187), c(188:190), c(191:193), c(194:197), c(198:201), c(202:205), c(206:209), c(210:212), c(213:215), c(216:218), c(219:223), c(224:226), c(227:231), 232, 233, c(234:238), c(239:243), c(244:245), c(246:247), c(248:250), c(251:253), c(254:256), c(257:264), c(265:267)))



plotAtlas(Atlas, pt.size=0.2, point = "s", legend = TRUE)

#This places the numbers of the landmarks as per the Atlas
#text3d(subtropicus.p1, texts = c(1:412), asp=FALSE, cex=2, col="blue", pos = 3 )


#testmesh <- file2mesh('3Dmodels/Asubtropicus/JM213.ply',readcol=T,clean=T)

#open3d()
#plotspec(testmesh, lmplacement[,,1], ptsize = 0.1  )

#text3d(lmplacement[,,1], texts = c(1:412), asp=FALSE, cex=1, col="blue", pos = 3 )

### 4th step apply the template to all the other specimens, remember to play with inflate/deflate
```


```{r semilandmark placement}
#The below is code to take out a small subsample of the whole 3d array
Folder <- "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data/3Dmodels/AntechinusTest/"

#Navigate to folder with the subsample of ply files
Plylist <- sub(".ply", "", list.files(Folder))

#extract the coordinates that correspond to the ply files - note the dimnames and the ply file names need to be identical

matching <- match(dimnames(Ants)[[3]],Plylist)
for_patch_placing <-which (!is.na(matching)==TRUE)

#Make an array that includes only the specimens you have in your folder
data <-Ants[, , for_patch_placing]

dimnames(data)[[3]]



lmplacement<-placePatch(Atlas,data,path=Folder, inflate=1) #ray=TRUE for projection along surface normals instead of closest point

checkLM(lmplacement, path = Folder, atlas=Atlas)



### look at the results

mfrow3d(4,3,sharedMouse = T)

shade3d(pilio,col=8)
spheres3d(pilio.new[1:40,],radius=0.35,col=1)
spheres3d(pilio.new[41:116,],radius=0.35,col=2)
spheres3d(pilio.new[117:522,],radius=0.35,col=3)

for(i in 1:dim(speci)[[3]]){
  
  next3d()
  shade3d(listish[[i]],col=8)
  spheres3d(speci[1:40,,i],radius=0.35,col=1)
  spheres3d(speci[41:116,,i],radius=0.35,col=2)
  spheres3d(speci[117:522,,i],radius=0.35,col=3)
  
}


### a few curves may present distortion, so make them equidistant again 
### (can use Bezier, but result are similar)

equi<-matrix(NA,ncol =3)
disto<-NULL
for(i in 1:dim(speci)[[3]]){
  ccc<-speci[51:60,,i]
  disto[i]<-list(equidistantCurve(ccc,iterations=10,increment=6,smoothit=4,mesh=listish[[i]]))
  equi<-array(as.numeric(unlist(disto)),dim=dim(speci[51:60,,]))
}


equi2<-matrix(NA,ncol =3)
disto.1<-NULL
for(i in 1:dim(speci)[[3]]){
  ccc1<-speci[41:50,,i]
  disto.1[i]<-list(equidistantCurve(ccc1,iterations=10,increment=8,smoothit=6,mesh=listish[[i]]))
  equi2<-array(as.numeric(unlist(disto.1)),dim=dim(speci[41:50,,]))
}



new.specis<-bindArr(speci[1:40,,],equi2,equi,speci[61:522,,],along=1)


listo<-listish[c(2,8,6)]
speco<-new.specis[,,c(2,8,6)]


mfrow3d(2,2,sharedMouse = T)

shade3d(pilio,col=8)
spheres3d(pilio.new[1:40,],radius=0.35,col=1)
spheres3d(pilio.new[41:116,],radius=0.35,col=2)
spheres3d(pilio.new[117:522,],radius=0.35,col=3)

for(i in 1:dim(speco)[[3]]){
  
  next3d()
  shade3d(listo[[i]],col=8)
  spheres3d(speco[1:40,,i],radius=0.5,col=1)
  spheres3d(speco[41:116,,i],radius=0.5,col=2)
  spheres3d(speco[117:522,,i],radius=0.5,col=3)
  
}


```


```{}
### Final, sliding process

setwd('/Users/colonnello/Desktop/New Brain')

fix<-c(1:40)

outlinesi<-list(c(41:50),c(51:60),c(61:67),c(68:70),c(71:75),c(76:80),c(81:83),c(84:88),c(89:95),
                c(96:98),c(99:103),c(104:108),c(109:111),c(112:116))

surfi<-c(117:522)

slidi<-slider3d(new.specis, SMvector = fix, deselect = T, surp=surfi, meshlist = listish, outlines=outlinesi )

slids<-slidi$dataslide

plot(slidi)



sli<-slids[,,c(2,8,6)]


mfrow3d(2,2,sharedMouse = T)

shade3d(pilio,col=8)
spheres3d(pilio.new[1:40,],radius=0.35,col=1)
spheres3d(pilio.new[41:116,],radius=0.35,col=2)
spheres3d(pilio.new[117:522,],radius=0.35,col=3)

for(i in 1:dim(speco)[[3]]){
  
  next3d()
  shade3d(listo[[i]],col=8)
  spheres3d(sli[1:40,,i],radius=0.5,col=1)
  spheres3d(sli[41:116,,i],radius=0.5,col=2)
  spheres3d(sli[117:522,,i],radius=0.5,col=3)
  
}




```
