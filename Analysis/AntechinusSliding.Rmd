---
title: "AntechinusSliding"
author: "PViacava"
date: "16/03/2020"
output: html_document
---
title: "Antechinus_sliding"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = '../Viacavaetal_Antechinus/Data', echo = TRUE)



library(Morpho)
library(rgl)
library(Rvcg)
library(geomorph)
library(abind)


```

```{r load data}

## import template mesh and landmark set

subtropicus.holo<-file2mesh('../Data/3Dmodels/Asubtropicus/J17407.ply',readcol=F,clean=T)
subtropicus.p<-(read.csv('../Data/Templatecoords.csv', header = F))

dim(subtropicus.p) 
rownames(subtropicus.p)<-subtropicus.p$V1 
subtropicus.p1 <- subtropicus.p[,-1]
dim(subtropicus.p1) #412 landmarks, 3 dimensions

#reordering landmarks: curves first, patches second and curves last
template.pf <- subtropicus.p1[1:82,]
template.pc <- subtropicus.p1[83:267,]
template.pp <- subtropicus.p1[268:412,]
template.p <- rbind(template.pf, template.pc, template.pp)

#VW trying to get this into an array - first turn each column into a vector
V2 <-template.p$V2
V3 <-template.p$V3
V4 <- template.p$V4
template_array <- array(c(V2, V3, V4), dim = c(412, 3, 1))

#plot landmarks on mesh to check if they correspond well
shade3d(subtropicus.holo,col = 8)
spheres3d(subtropicus.p1[1:82,],radius = 0.3,col = 1)#fixed. nb of landmarks = (  z-1)/3  82
spheres3d(subtropicus.p1[83:267,],radius = 0.2,col = 2) #curves 185
spheres3d(subtropicus.p1[268:412,],radius = 0.1,col = 3) #patches 145

text3d(subtropicus.p1, texts = c(1:412), asp = FALSE, cex = 1, col="blue", pos = 3) #plot number of landmarks to check ordering

#import landmark sets for all specimens
LMcoords <- t(read.csv('../Data/Antechinus_LMcoords.csv', header = T, row.names = 1))
dim(LMcoords)
Ants <- arrayspecs(LMcoords, 82, 3) #convert into array
dim(Ants)
Ahead <- head(dimnames(Ants))[3]
```

```{r template creation}

# specify fixed landmarks of template specimen in a matrix
fixed<-as.matrix(template_array[c(1:82),,])

# specify semilandmarks of template specimen in a matrix
patch<-as.matrix(template_array[c(83:412),,])


# Specify curves 
SC1<-as.integer(1)
SC2<-as.integer(c(2:4))
SC3<-as.integer(c(5:7))
SC4<-as.integer(c(8:10))
SC5<-as.integer(c(11:13))
SC6<-as.integer(14)
SC7<-as.integer(c(15:22))
SC8<-as.integer(c(23:25))
SC9<-as.integer(c(26:28))
SC10<-as.integer(c(29:31))
SC11<-as.integer(c(32:34))
SC12<-as.integer(c(35:38))
SC13<-as.integer(c(39:42))
SC14<-as.integer(c(43:45))
SC15<-as.integer(c(46:48))
SC16<-as.integer(c(49:50))
SC17<-as.integer(c(51:52))
SC18<-as.integer(c(53:54))
SC19<-as.integer(c(55:56))
SC20<-as.integer(c(57:61))
SC21<-as.integer(c(62:66))
SC22<-as.integer(c(67:69))
SC23<-as.integer(c(70:71))
SC24<-as.integer(c(72:75))
SC25<-as.integer(c(76:77))
SC26<-as.integer(78)
SC27<-as.integer(79)
SC28<-as.integer(80)
SC29<-as.integer(81)
SC30<-as.integer(c(82:84))
SC31<-as.integer(c(85:86))
SC32<-as.integer(c(87:90))
SC33<-as.integer(c(91:92))
SC34<-as.integer(93)
SC35<-as.integer(94)
SC36<-as.integer(95)
SC37<-as.integer(96)
SC38<-as.integer(c(97:98))
SC39<-as.integer(c(99:100))
SC40<-as.integer(c(101:105))
SC41<-as.integer(c(106:108))
SC42<-as.integer(c(109:111))
SC43<-as.integer(c(112:115))
SC44<-as.integer(c(116:119))
SC45<-as.integer(c(120:123))
SC46<-as.integer(c(124:127))
SC47<-as.integer(c(128:130))
SC48<-as.integer(c(131:133))
SC49<-as.integer(c(134:136))
SC50<-as.integer(c(137:141))
SC51<-as.integer(c(142:144))
SC52<-as.integer(c(145:149))
SC53<-as.integer(150)
SC54<-as.integer(151)
SC55<-as.integer(c(152:156))
SC56<-as.integer(c(157:161))
SC57<-as.integer(c(162:163))
SC58<-as.integer(c(164:165))
SC59<-as.integer(c(166:168))
SC60<-as.integer(c(169:171))
SC61<-as.integer(c(172:174))
SC62<-as.integer(c(175:182))
SC63<-as.integer(c(183:185))



#List curves
curves<-list(SC1,SC2,SC3,SC4,SC5,SC6,SC7,SC8,SC9,SC10,SC11,SC12,SC13,SC14,SC15,SC16,SC17,SC18,SC19,SC20,         SC21,SC22,SC23,SC24,SC25,SC26,SC27,SC28,SC29,SC30,SC31,SC32,SC33,SC34,SC35,SC36,SC37,SC38,SC39,SC40,SC41,SC42,SC43,SC44,SC45,SC46,SC47,SC48,SC49,SC50,SC51,SC52,SC53,SC54,SC55,SC56,SC57,SC58,SC59,SC60,SC61,SC62,SC63)

#Atlas creation
Atlas<-createAtlas(subtropicus.holo,landmarks = fixed, patch = patch, patchCurves = curves)

#Atlas plot 
cols<-c("black","red","green","blue")
plotAtlas(Atlas, pt.size=0.2, point = "s", legend = TRUE, cols = cols)


```


```{r semilandmark placement}

#Folder with all meshes
Folder <- "../Data/3Dmodels/AntechinusTest/"

#Navigate to folder with the subsample of ply files
Plylist <- sub(".ply", "", list.files(Folder))

#extract the coordinates that correspond to the ply files - note the dimnames and the ply file names need to be identical
#match ply file names with data names and reorder

match(Plylist, dimnames(Ants)[[3]])

Plylist==dimnames(Ants)[[3]]

data_reorder<-Ants[, , match(Plylist, dimnames(Ants)[[3]])]


names_reorder<-dimnames(data_reorder)[[3]]
match(names_reorder, Plylist)

dimnames(data_reorder)[[3]] == Plylist

#semilandmark placement in all specimenes


lmplacement<-placePatch(Atlas, data_reorder, path="../Data/3Dmodels/AntechinusTest/", inflate=1) # use ray=TRUE for projection along surface normals instead of closest point???

#check good placement of semilandmarks in all specimens
checkLM(lmplacement, path = "../Data/3Dmodels/AntechinusTest/", atlas=Atlas, point = "s", pt.size = 5)


```
