---
title: "AntechinusSliding"
author: "PViacava"
date: "16/03/2020"
output: html_document
---
title: "Antechinus_sliding"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = 'C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data', echo = TRUE)



library(Morpho)
library(rgl)
library(Rvcg)
library(geomorph)
library(abind)

#this is not needed in RMD
#setwd('C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data')
```

```{r load data}

## import meshes and points cloud

# SEE HOW I CHANGED THE PATHS TO BE ../path/path/file?  ANY FILES IN OTHER FOLDERS NEED TO BE NAVIGATED TO LIKE THIS. AND YOU COULD NOT KNOW THIS. I DIDN'T SEE IT EITHER. 


subtropicus.holo<-file2mesh('../Data/3Dmodels/Asubtropicus/J17407.ply',readcol=F,clean=T)
subtropicus.p<-(read.csv('../Data/Templatecoords.csv', header = F))
dim(subtropicus.p)
rownames(subtropicus.p)<-subtropicus.p$V1

subtropicus.p1 <- subtropicus.p[,-1]

template.pf <- subtropicus.p1[1:82,]
template.pc <- subtropicus.p1[83:267,]
template.pp <- subtropicus.p1[268:412,]

template.p <- rbind(template.pf, template.pp, template.pc)

#A <- arrayspecs(subtropicus.p1, 412, 3)
#dim(A)
#Ahead <- head(dimnames(A))[3]
#template.p<-A[,,1]
#antestspecs<-A[,,2:5]
shade3d(subtropicus.holo,col=8)
spheres3d(subtropicus.p1[1:82,],radius=0.3,col=1)#fixed. nb of landmarks = (z-1)/3  82
spheres3d(subtropicus.p1[83:267,],radius=0.2,col=2) #curves 185
spheres3d(subtropicus.p1[268:412,],radius=0.1,col=3) #patches 145

text3d(subtropicus.p1, texts = c(1:412), asp=FALSE, cex=1, col="blue", pos = 3 )

LMcoords <- t(read.csv('../Data/Antechinus_cranialvariation_data.csv', header = T, row.names = 1))
dim(LMcoords)
Ants <- arrayspecs(LMcoords, 82, 3)
dim(Ants)
Ahead <- head(dimnames(Ants))[3]
```

### 2nd step build symmetric patches, you can do this or not, it depends on your question.
## don't run now

#rpm<-c(1:27)
#lpm<-c(82:108)
#pm<-cbind(rpm,lpm)
#rfp<-c(28:50)
#lfp<-c(115:137)
#fp<-cbind(rfp,lfp)
#rn<-c(64:72)
#ln<-c(73:81)
#n<-cbind(rn,ln)

#sepe, oc and bo to do symmetrize

#symme1<-Morpho::symmetrize(c(template.p[1:27,], template.p[82:108]),pm)#128
#symme2<-Morpho::symmetrize(template.p[373:422,],fp)#50
#symme3<-Morpho::symmetrize(template.p[423:472,],n)#50

#reprojecting the points to the surface
#proji<-projRead(symme,pilio)
#proji1<-projRead(symme1,pilio)
#proji2<-projRead(symme2,pilio)
#proji3<-projRead(symme3,pilio)



#sym.patch<-t(proji$vb)[,-4]
#sym.patch1<-t(proji1$vb)[,-4]
#sym.patch2<-t(proji2$vb)[,-4]
#sym.patch3<-t(proji3$vb)[,-4]


## new set of points with symmetrically places points

#pilio.new<-rbind(pilio.p[1:40,],pilio.curves,pilio.p[117:522,])#sym.patch,sym.patch1,sym.patch2,sym.patch3,sym.patch4,sym.patch5)

#shade3d(pilio,col=8)
#spheres3d(pilio.new[505:522,],radius=0.5,col=1)
#text3d(pilio.new[505:522,1],pilio.new[505:522,2],pilio.new[505:522,3],c(505:522),cex=1.5,adj =1.5)

#spheres3d(pilio.new[41:116,],radius=0.5,col=2)
#spheres3d(pilio.new[117:522,],radius=0.5,col=3)

## read all points
#export in pts

#setwd("/Users/colonnello/Desktop/New Brain/points")
#nm<-list.files(path="/Users/colonnello/Desktop/New Brain/points")
#list.pts<-do.call(list,lapply(nm,function(x) read.pts(x)))

#try.arr<-array(unlist(list.pts),dim=c(40,3,9))
#40 = lms , 3 dimensions and 9 specimens
## all the meshes 
#setwd("/Users/colonnello/Desktop/New Brain/prova")
#nm2<-list.files(path="/Users/colonnello/Desktop/New Brain/prova")
#listish<-do.call(list,lapply(nm2,function(x) file2mesh(x,readcol=F,clean=T)))

## match names, very important

#nmi<-substr(nm2,1,nchar(nm2)-4)

#dimnames(try.arr)[[3]]<-nmi

```{r template creation}

#### create the template

fixed<-as.matrix(subtropicus.p1[c(1:82),])

#fixed<-as.matrix(template.p[1:82,])


patch<-as.matrix(subtropicus.p1[c(83:412),])

#patch<-as.matrix(template.p[83:412,])


#patch semilandmark rows don't need renaming because they come first



#template.1<-createAtlas(subtropicus.holo,landmarks=fixed,patch=patch,
                        
         #patchCurves = list(as.integer(template.p[c(228:235),])))


#plotAtlas(template.1,pt.size=0.2,legend=FALSE,render="s")

# Declaration of rowindices of curves 
SC1<-as.integer(1)
SC2<-as.integer(c(2:4))
SC3<-as.integer(c(5:7))
SC4<-as.integer(c(8:10))
SC5<-as.integer(c(11:13))
SC6<-as.integer(14)
SC7<-as.integer(c(15:22))
SC8<-as.integer(c(23:25))
SC9<-as.integer(c(26:28))
SC10<-as.integer(c(29:31))
SC11<-as.integer(c(32:34))
SC12<-as.integer(c(35:38))
SC13<-as.integer(c(39:42))
SC14<-as.integer(c(43:45))
SC15<-as.integer(c(46:48))
SC16<-as.integer(c(49:50))
SC17<-as.integer(c(51:52))
SC18<-as.integer(c(53:54))
SC19<-as.integer(c(55:56))
SC20<-as.integer(c(57:61))
SC21<-as.integer(c(62:66))
SC22<-as.integer(c(67:69))
SC23<-as.integer(c(70:71))
SC24<-as.integer(c(72:75))
SC25<-as.integer(c(76:77))
SC26<-as.integer(78)
SC27<-as.integer(79)
SC28<-as.integer(80)
SC29<-as.integer(81)
SC30<-as.integer(c(82:84))
SC31<-as.integer(c(85:86))
SC32<-as.integer(c(87:90))
SC33<-as.integer(c(91:92))
SC34<-as.integer(93)
SC35<-as.integer(94)
SC36<-as.integer(95)
SC37<-as.integer(96)
SC38<-as.integer(c(97:98))
SC39<-as.integer(c(99:100))
SC40<-as.integer(c(101:105))
SC41<-as.integer(c(106:108))
SC42<-as.integer(c(109:111))
SC43<-as.integer(c(112:115))
SC44<-as.integer(c(116:119))
SC45<-as.integer(c(120:123))
SC46<-as.integer(c(124:127))
SC47<-as.integer(c(128:130))
SC48<-as.integer(c(131:133))
SC49<-as.integer(c(134:136))
SC50<-as.integer(c(137:141))
SC51<-as.integer(c(142:144))
SC52<-as.integer(c(145:149))
SC53<-as.integer(150)
SC54<-as.integer(151)
SC55<-as.integer(c(152:156))
SC56<-as.integer(c(157:161))
SC57<-as.integer(c(162:163))
SC58<-as.integer(c(164:165))
SC59<-as.integer(c(166:168))
SC60<-as.integer(c(169:171))
SC61<-as.integer(c(172:174))
SC62<-as.integer(c(175:182))
SC63<-as.integer(c(183:185))


# Creation d'une liste de toutes les courbes, incluant les lm anatomiques bordant les courbes

#curves1<-list(SC2,SC3)
curves<-list(SC1,SC2,SC3,SC4,SC5,SC6,SC7,SC8,SC9,SC10,SC11,SC12,SC13,SC14,SC15,SC16,SC17,SC18,SC19,SC20,         SC21,SC22,SC23,SC24,SC25,SC26,SC27,SC28,SC29,SC30,SC31,SC32,SC33,SC34,SC35,SC36,SC37,SC38,SC39,SC40,SC41,SC42,SC43,SC44,SC45,SC46,SC47,SC48,SC49,SC50,SC51,SC52,SC53,SC54,SC55,SC56,SC57,SC58,SC59,SC60,SC61,SC62,SC63)

#Atlas plot and original plot to check if the landmark numbers remain in the same order 

#Atlas<-createAtlas(subtropicus.holo,landmarks=fixed,patch=patch, patchCurves = curves1)
Atlas<-createAtlas(subtropicus.holo,landmarks=fixed,patch=patch, patchCurves = list(as.integer(c(320:327)))) 

Atlas<-createAtlas(subtropicus.holo,landmarks=fixed,patch=patch, patchCurves = curves)



plotAtlas(Atlas, pt.size=0.2, point = "s", legend = TRUE, cols = "black", "red", "green", "blue")


col<-colours("black","red","green","blue")

#This places the numbers of the landmarks as per the Atlas
#text3d(subtropicus.p1, texts = c(1:412), asp=FALSE, cex=2, col="blue", pos = 3 )


#testmesh <- file2mesh('3Dmodels/Asubtropicus/JM213.ply',readcol=T,clean=T)

#open3d()
#plotspec(testmesh, lmplacement[,,1], ptsize = 0.1  )

#text3d(lmplacement[,,1], texts = c(1:412), asp=FALSE, cex=1, col="blue", pos = 3 )

### 4th step apply the template to all the other specimens, remember to play with inflate/deflate
```


```{r semilandmark placement}
#The below is code to take out a small subsample of the whole 3d array
Folder <- "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_Antechinus/Data/3Dmodels/AntechinusTest/"

#Navigate to folder with the subsample of ply files
Plylist <- sub(".ply", "", list.files(Folder))

#extract the coordinates that correspond to the ply files - note the dimnames and the ply file names need to be identical

match(Plylist, dimnames(Ants)[[3]])
data_reorder<-Ants[, , match(Plylist, dimnames(Ants)[[3]])]


names_reorder<-dimnames(data_reorder)[[3]]
match(names_reorder, Plylist)














lmplacement<-placePatch(Atlas,data_reorder,path=Folder, inflate=1) #ray=TRUE for projection along surface normals instead of closest point

checkLM(lmplacement, path = Folder, atlas=Atlas)



### look at the results

mfrow3d(4,3,sharedMouse = T)

shade3d(pilio,col=8)
spheres3d(pilio.new[1:40,],radius=0.35,col=1)
spheres3d(pilio.new[41:116,],radius=0.35,col=2)
spheres3d(pilio.new[117:522,],radius=0.35,col=3)

for(i in 1:dim(speci)[[3]]){
  
  next3d()
  shade3d(listish[[i]],col=8)
  spheres3d(speci[1:40,,i],radius=0.35,col=1)
  spheres3d(speci[41:116,,i],radius=0.35,col=2)
  spheres3d(speci[117:522,,i],radius=0.35,col=3)
  
}


### a few curves may present distortion, so make them equidistant again 
### (can use Bezier, but result are similar)

equi<-matrix(NA,ncol =3)
disto<-NULL
for(i in 1:dim(speci)[[3]]){
  ccc<-speci[51:60,,i]
  disto[i]<-list(equidistantCurve(ccc,iterations=10,increment=6,smoothit=4,mesh=listish[[i]]))
  equi<-array(as.numeric(unlist(disto)),dim=dim(speci[51:60,,]))
}


equi2<-matrix(NA,ncol =3)
disto.1<-NULL
for(i in 1:dim(speci)[[3]]){
  ccc1<-speci[41:50,,i]
  disto.1[i]<-list(equidistantCurve(ccc1,iterations=10,increment=8,smoothit=6,mesh=listish[[i]]))
  equi2<-array(as.numeric(unlist(disto.1)),dim=dim(speci[41:50,,]))
}



new.specis<-bindArr(speci[1:40,,],equi2,equi,speci[61:522,,],along=1)


listo<-listish[c(2,8,6)]
speco<-new.specis[,,c(2,8,6)]


mfrow3d(2,2,sharedMouse = T)

shade3d(pilio,col=8)
spheres3d(pilio.new[1:40,],radius=0.35,col=1)
spheres3d(pilio.new[41:116,],radius=0.35,col=2)
spheres3d(pilio.new[117:522,],radius=0.35,col=3)

for(i in 1:dim(speco)[[3]]){
  
  next3d()
  shade3d(listo[[i]],col=8)
  spheres3d(speco[1:40,,i],radius=0.5,col=1)
  spheres3d(speco[41:116,,i],radius=0.5,col=2)
  spheres3d(speco[117:522,,i],radius=0.5,col=3)
  
}


```


```{}
### Final, sliding process

setwd('/Users/colonnello/Desktop/New Brain')

fix<-c(1:40)

outlinesi<-list(c(41:50),c(51:60),c(61:67),c(68:70),c(71:75),c(76:80),c(81:83),c(84:88),c(89:95),
                c(96:98),c(99:103),c(104:108),c(109:111),c(112:116))

surfi<-c(117:522)

slidi<-slider3d(new.specis, SMvector = fix, deselect = T, surp=surfi, meshlist = listish, outlines=outlinesi )

slids<-slidi$dataslide

plot(slidi)



sli<-slids[,,c(2,8,6)]


mfrow3d(2,2,sharedMouse = T)

shade3d(pilio,col=8)
spheres3d(pilio.new[1:40,],radius=0.35,col=1)
spheres3d(pilio.new[41:116,],radius=0.35,col=2)
spheres3d(pilio.new[117:522,],radius=0.35,col=3)

for(i in 1:dim(speco)[[3]]){
  
  next3d()
  shade3d(listo[[i]],col=8)
  spheres3d(sli[1:40,,i],radius=0.5,col=1)
  spheres3d(sli[41:116,,i],radius=0.5,col=2)
  spheres3d(sli[117:522,,i],radius=0.5,col=3)
  
}




```
